{% extends 'base.html' %}
{% block title %}QR Scanner - Check In{% endblock %}
{% block content %}
<style>
    .scanner-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 2rem 1rem;
    }
    .scanner-header {
        text-align: center;
        margin-bottom: 2rem;
    }
    .scanner-title {
        font-family: 'Syne', sans-serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.5rem;
    }
    .scanner-subtitle {
        color: #6b7280;
        font-size: 0.95rem;
    }
    .back-link {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: #6b7280;
        font-size: 0.875rem;
        transition: color 0.2s ease;
        text-decoration: none;
        margin-bottom: 1rem;
    }
    .back-link:hover {
        color: #06b6d4;
        text-decoration: none;
    }
    
    /* Scanner Card */
    .scanner-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 20px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 
            0 8px 32px rgba(0, 0, 0, 0.3),
            inset 0 1px 0 rgba(255, 255, 255, 0.1);
    }
    
    /* Scanner Area */
    #qr-reader {
        width: 100%;
        border-radius: 12px;
        overflow: hidden;
    }
    #qr-reader video {
        border-radius: 12px;
    }
    #qr-reader__scan_region {
        background: transparent !important;
    }
    #qr-reader__scan_region img {
        display: none !important;
    }
    #qr-reader__dashboard {
        padding: 1rem !important;
    }
    #qr-reader__dashboard_section {
        padding: 0.5rem !important;
    }
    #qr-reader__dashboard_section_csr button {
        background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%) !important;
        color: #000 !important;
        border: none !important;
        padding: 0.75rem 1.5rem !important;
        border-radius: 10px !important;
        font-weight: 600 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
    }
    #qr-reader__dashboard_section_csr button:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3) !important;
    }
    #qr-reader__dashboard_section_csr select {
        background: rgba(255,255,255,0.05) !important;
        color: #fff !important;
        border: 1px solid rgba(255,255,255,0.1) !important;
        padding: 0.5rem !important;
        border-radius: 8px !important;
    }
    #qr-reader__status_span {
        background: transparent !important;
        color: #9ca3af !important;
    }
    
    /* Result Display */
    .result-card {
        background: rgba(255, 255, 255, 0.03);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        display: none;
    }
    .result-card.show {
        display: block;
    }
    .result-card.success {
        border-color: rgba(34, 197, 94, 0.3);
        background: rgba(34, 197, 94, 0.05);
    }
    .result-card.error {
        border-color: rgba(239, 68, 68, 0.3);
        background: rgba(239, 68, 68, 0.05);
    }
    .result-card.warning {
        border-color: rgba(249, 115, 22, 0.3);
        background: rgba(249, 115, 22, 0.05);
    }
    .result-icon {
        width: 60px;
        height: 60px;
        margin: 0 auto 1rem;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
    }
    .result-card.success .result-icon {
        background: rgba(34, 197, 94, 0.15);
    }
    .result-card.error .result-icon {
        background: rgba(239, 68, 68, 0.15);
    }
    .result-card.warning .result-icon {
        background: rgba(249, 115, 22, 0.15);
    }
    .result-message {
        text-align: center;
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 0.5rem;
    }
    .result-details {
        text-align: center;
        color: #9ca3af;
        font-size: 0.9rem;
    }
    .result-details strong {
        color: #d1d5db;
    }
    
    /* Attendee Info */
    .attendee-info {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }
    .attendee-row {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
    }
    .attendee-row .label {
        color: #6b7280;
    }
    .attendee-row .value {
        color: #d1d5db;
        font-weight: 500;
    }
    
    /* Scan History */
    .scan-history {
        margin-top: 2rem;
    }
    .history-title {
        font-size: 1rem;
        font-weight: 600;
        color: #fff;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .history-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        max-height: 250px;
        overflow-y: auto;
    }
    .history-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        background: rgba(255,255,255,0.02);
        border-radius: 10px;
        border-left: 3px solid #22c55e;
    }
    .history-item.failed {
        border-left-color: #ef4444;
    }
    .history-avatar {
        width: 36px;
        height: 36px;
        display: flex;
        align-items: center;
        justify-content: center;
        background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
        border-radius: 50%;
        font-weight: 600;
        font-size: 0.8rem;
        color: #000;
    }
    .history-info {
        flex: 1;
    }
    .history-name {
        font-weight: 500;
        color: #fff;
        font-size: 0.875rem;
    }
    .history-event {
        font-size: 0.75rem;
        color: #6b7280;
    }
    .history-time {
        font-size: 0.7rem;
        color: #4b5563;
    }
    
    /* Manual Input */
    .manual-input-section {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255,255,255,0.08);
    }
    .manual-label {
        display: block;
        color: #9ca3af;
        font-size: 0.85rem;
        margin-bottom: 0.5rem;
    }
    .manual-input-row {
        display: flex;
        gap: 0.5rem;
    }
    .manual-input {
        flex: 1;
        padding: 0.75rem 1rem;
        background: rgba(255,255,255,0.03);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 10px;
        color: #fff;
        font-size: 0.9rem;
    }
    .manual-input:focus {
        outline: none;
        border-color: #06b6d4;
    }
    .manual-input::placeholder {
        color: #4b5563;
    }
    .btn-manual {
        padding: 0.75rem 1.25rem;
        background: linear-gradient(135deg, #06b6d4 0%, #22d3ee 100%);
        border: none;
        border-radius: 10px;
        color: #000;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .btn-manual:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3);
    }
    
    /* Stats Bar */
    .stats-bar {
        display: flex;
        justify-content: center;
        gap: 2rem;
        padding: 1rem;
        background: rgba(255,255,255,0.02);
        border-radius: 12px;
        margin-bottom: 1.5rem;
    }
    .stat-item {
        text-align: center;
    }
    .stat-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: #22c55e;
    }
    .stat-label {
        font-size: 0.75rem;
        color: #6b7280;
    }
    
    /* Sound Toggle */
    .sound-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 1rem;
        color: #6b7280;
        font-size: 0.85rem;
    }
    .sound-toggle input {
        accent-color: #06b6d4;
    }
    
    @media (max-width: 480px) {
        .scanner-container {
            padding: 1rem 0.75rem;
        }
        .scanner-card {
            padding: 1rem;
        }
        .stats-bar {
            gap: 1rem;
        }
    }
</style>

<!-- Load html5-qrcode library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<div class="scanner-container">
    <div class="scanner-header">
        <a href="{{ url_for('organizer_dashboard') }}" class="back-link">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back to Dashboard
        </a>
        <h1 class="scanner-title">QR Check-In Scanner</h1>
        <p class="scanner-subtitle">Scan attendee QR codes for instant check-in</p>
    </div>
    
    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <div class="stat-value" id="scanCount">0</div>
            <div class="stat-label">Scanned Today</div>
        </div>
        <div class="stat-item">
            <div class="stat-value" id="successCount">0</div>
            <div class="stat-label">Successful</div>
        </div>
    </div>
    
    <!-- Result Display -->
    <div class="result-card" id="resultCard">
        <div class="result-icon" id="resultIcon">✓</div>
        <div class="result-message" id="resultMessage">Check-in successful!</div>
        <div class="result-details" id="resultDetails"></div>
        <div class="attendee-info" id="attendeeInfo"></div>
    </div>
    
    <!-- Scanner Card -->
    <div class="scanner-card">
        <div class="sound-toggle">
            <input type="checkbox" id="soundEnabled" checked>
            <label for="soundEnabled">Sound effects</label>
        </div>
        
        <div id="qr-reader"></div>
        
        <!-- Manual Input -->
        <div class="manual-input-section">
            <label class="manual-label">Or enter ticket code manually:</label>
            <div class="manual-input-row">
                <input type="text" class="manual-input" id="manualCode" placeholder="Enter QR code value...">
                <button class="btn-manual" onclick="manualCheckIn()">Check In</button>
            </div>
        </div>
    </div>
    
    <!-- Scan History -->
    <div class="scan-history">
        <h3 class="history-title">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            Recent Scans
        </h3>
        <div class="history-list" id="historyList">
            <div style="text-align: center; color: #6b7280; padding: 1rem;">
                No scans yet. Start scanning QR codes!
            </div>
        </div>
    </div>
</div>

<!-- Success Sound -->
<audio id="successSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2teleUhJk9Lop3NgQE6Y1+2paV1MWpPT6qJsZlZekNbrn25rXmKP1eqYcG9iZY7T6I9xcGRlj9TminiIXmeW1OqIeI1ecZXS54Z8kGF1ltLnhH6PYXmW0ueBfJBhe5bS54F7j2F9ltLmgXqPYoCW0uV/eY5hgpbS5H14jWGEltLkeXeNYYSW0uR3cowAAA==" type="audio/wav">
</audio>
<audio id="errorSound" preload="auto">
    <source src="data:audio/wav;base64,UklGRigCAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQQCAACAgICAgICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/f39/gICAgICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/f39/f39/f39/f39/gICAgICAgICAgICAgICAgIB/f39/f39/f39/f39/gICAgA==" type="audio/wav">
</audio>

<script>
let scanCount = 0;
let successCount = 0;
let html5QrCode;
let isProcessing = false;

// Initialize scanner
document.addEventListener('DOMContentLoaded', function() {
    html5QrCode = new Html5Qrcode("qr-reader");
    
    const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
    };
    
    Html5Qrcode.getCameras().then(devices => {
        if (devices && devices.length) {
            // Prefer back camera on mobile
            const backCamera = devices.find(d => d.label.toLowerCase().includes('back')) || devices[0];
            startScanner(backCamera.id, config);
        }
    }).catch(err => {
        console.log("Error getting cameras:", err);
        // Show file upload option instead
        html5QrCode.start(
            { facingMode: "environment" },
            config,
            onScanSuccess,
            onScanFailure
        ).catch(err => {
            document.getElementById('qr-reader').innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #9ca3af;">
                    <p>Camera not available. Please use manual input below.</p>
                </div>
            `;
        });
    });
});

function startScanner(cameraId, config) {
    html5QrCode.start(
        cameraId,
        config,
        onScanSuccess,
        onScanFailure
    ).catch(err => {
        console.log("Error starting scanner:", err);
    });
}

async function onScanSuccess(decodedText, decodedResult) {
    if (isProcessing) return;
    isProcessing = true;
    
    await processCheckIn(decodedText);
    
    // Add delay before allowing next scan
    setTimeout(() => {
        isProcessing = false;
    }, 2000);
}

function onScanFailure(error) {
    // Silently ignore scan failures (no QR in view)
}

async function processCheckIn(token) {
    scanCount++;
    document.getElementById('scanCount').textContent = scanCount;
    
    try {
        const response = await fetch('/api/checkin/qr', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ token: token })
        });
        
        const data = await response.json();
        
        if (data.success) {
            successCount++;
            document.getElementById('successCount').textContent = successCount;
            showResult('success', data.message, data.attendee);
            playSound('success');
            addToHistory(data.attendee, true);
        } else {
            showResult(data.error.includes('Already') ? 'warning' : 'error', data.error, data.attendee);
            playSound('error');
            if (data.attendee) {
                addToHistory(data.attendee, false, data.error);
            }
        }
    } catch (error) {
        showResult('error', 'Network error. Please try again.');
        playSound('error');
    }
}

function showResult(type, message, attendee) {
    const card = document.getElementById('resultCard');
    const icon = document.getElementById('resultIcon');
    const msg = document.getElementById('resultMessage');
    const details = document.getElementById('resultDetails');
    const info = document.getElementById('attendeeInfo');
    
    card.className = `result-card show ${type}`;
    
    if (type === 'success') {
        icon.textContent = '✓';
    } else if (type === 'warning') {
        icon.textContent = '⚠';
    } else {
        icon.textContent = '✕';
    }
    
    msg.textContent = message;
    
    if (attendee) {
        details.innerHTML = `<strong>${attendee.name}</strong>`;
        info.innerHTML = `
            <div class="attendee-row">
                <span class="label">Email</span>
                <span class="value">${attendee.email}</span>
            </div>
            <div class="attendee-row">
                <span class="label">Event</span>
                <span class="value">${attendee.event}</span>
            </div>
            ${attendee.check_in_time ? `
            <div class="attendee-row">
                <span class="label">Time</span>
                <span class="value">${attendee.check_in_time}</span>
            </div>
            ` : ''}
        `;
    } else {
        details.innerHTML = '';
        info.innerHTML = '';
    }
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        card.classList.remove('show');
    }, 5000);
}

function playSound(type) {
    if (!document.getElementById('soundEnabled').checked) return;
    
    const sound = document.getElementById(type === 'success' ? 'successSound' : 'errorSound');
    sound.currentTime = 0;
    sound.play().catch(() => {});
}

function addToHistory(attendee, success, error) {
    const list = document.getElementById('historyList');
    
    // Clear placeholder if exists
    if (list.children.length === 1 && list.children[0].style.textAlign === 'center') {
        list.innerHTML = '';
    }
    
    const item = document.createElement('div');
    item.className = `history-item ${success ? '' : 'failed'}`;
    item.innerHTML = `
        <div class="history-avatar">${attendee.name ? attendee.name[0].toUpperCase() : '?'}</div>
        <div class="history-info">
            <div class="history-name">${attendee.name || 'Unknown'} ${success ? '' : `<span style="color: #ef4444;">(${error || 'Failed'})</span>`}</div>
            <div class="history-event">${attendee.event || 'Unknown event'}</div>
        </div>
        <div class="history-time">${new Date().toLocaleTimeString()}</div>
    `;
    
    list.insertBefore(item, list.firstChild);
    
    // Keep only last 20 items
    while (list.children.length > 20) {
        list.removeChild(list.lastChild);
    }
}

function manualCheckIn() {
    const input = document.getElementById('manualCode');
    const token = input.value.trim();
    
    if (!token) {
        showResult('error', 'Please enter a ticket code');
        return;
    }
    
    processCheckIn(token);
    input.value = '';
}

// Enter key for manual input
document.getElementById('manualCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        manualCheckIn();
    }
});
</script>
{% endblock %}
